{
  "uid": "iot-overview",
  "title": "IoT Telemetry Pipeline (Kafka + Hikari)",
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "5s",
  "panels": [
    {
      "type": "timeseries",
      "title": "JVM Heap Used (MB)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "jvm_memory_used_bytes{area=\"heap\"} / 1024 / 1024",
          "legendFormat": "{{application}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "megabytes" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 }
    },
    {
      "type": "timeseries",
      "title": "CPU Usage (process_cpu_usage)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "process_cpu_usage",
          "legendFormat": "{{application}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "percentunit" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 }
    },
    {
      "type": "timeseries",
      "title": "HTTP req/s by URI & status",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "sum by (application, uri, status) (rate(http_server_requests_seconds_count[1m]))",
          "legendFormat": "{{application}} {{uri}} {{status}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 }
    },
    {
      "type": "timeseries",
      "title": "Kafka Produced records/s (by topic)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "sum by (topic) (rate(kafka_producer_record_send_total{topic!~\"__.*\"}[1m]))",
          "legendFormat": "{{topic}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 }
    },
    {
      "type": "timeseries",
      "title": "Kafka Consumed records/s (topic • client • listener)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (topic) (rate(kafka_consumer_records_consumed_total{topic!~\"__.*\"}[2m]))",
          "legendFormat": "topic={{topic}}"
        },
        {
          "refId": "B",
          "expr": "sum by (client_id) (rate(kafka_consumer_records_consumed_total[2m]))",
          "legendFormat": "client={{client_id}}"
        },
        {
          "refId": "C",
          "expr": "sum by (listener) (rate(spring_kafka_listener_seconds_count[2m]))",
          "legendFormat": "listener={{listener}} calls/s"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 }
    },
    {
      "type": "timeseries",
      "title": "Kafka Consumer Lag (client view)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "refId": "A",
          "expr": "max by (client_id, topic) (kafka_consumer_records_lag_max)",
          "legendFormat": "{{client_id}} {{topic}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 }
    },
    {
      "type": "timeseries",
      "title": "DB Connections Active",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "hikari_connections_active", "legendFormat": "{{application}} {{pool}}" },
        { "refId": "B", "expr": "jdbc_connections_active",  "legendFormat": "{{application}} (jdbc)" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 6, "x": 12, "y": 24 }
    },
    {
      "type": "timeseries",
      "title": "DB Connections Idle",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "hikari_connections_idle", "legendFormat": "{{application}} {{pool}}" },
        { "refId": "B", "expr": "jdbc_connections_idle",  "legendFormat": "{{application}} (jdbc)" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 6, "x": 18, "y": 24 }
    },
    {
      "type": "timeseries",
      "title": "DB Connections Pending",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "hikari_connections_pending", "legendFormat": "{{application}} {{pool}}" },
        { "refId": "B", "expr": "jdbc_connections_pending",  "legendFormat": "{{application}} (jdbc)" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 32 }
    },
    {
      "type": "timeseries",
      "title": "DB Pool Utilization (%)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "hikari_connections_usage_ratio * 100", "legendFormat": "{{application}} {{pool}}" },
        { "refId": "B", "expr": "(jdbc_connections_active / jdbc_connections_max) * 100", "legendFormat": "{{application}} (jdbc)" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" }, "overrides": [] },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 32 }
    },
    {
      "type": "timeseries",
      "title": "Ingest: records/s (ok vs bad)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "sum by (application) (rate(ingest_records_parsed_total[1m]))",  "legendFormat": "{{application}} ok/s" },
        { "refId": "B", "expr": "sum by (application) (rate(ingest_records_invalid_total[1m]))", "legendFormat": "{{application}} bad/s" }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 40 }
    },
    {
      "type": "timeseries",
      "title": "Ingest: batch duration (p95)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(ingest_batch_latency_seconds_bucket[5m])))",
          "legendFormat": "p95"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 6, "x": 12, "y": 40 }
    },
    {
      "type": "stat",
      "title": "Ingest: batches/s",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "expr": "sum(rate(ingest_batch_latency_seconds_count[1m]))", "legendFormat": "batches/s" }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 6, "x": 18, "y": 40 }
    },
    {
      "type": "timeseries",
      "title": "Agg: rows written/s (sensor & group)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "refId": "A", "expr": "sum(rate(agg_rows_sensor_total[1m]))", "legendFormat": "sensor rows/s" },
        { "refId": "B", "expr": "sum(rate(agg_rows_group_total[1m]))",  "legendFormat": "group rows/s" }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 47 }
    },
    {
      "type": "stat",
      "title": "Agg: minutes processed/s",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        { "expr": "sum(rate(agg_minutes_processed_total[1m]))", "legendFormat": "mins/s" }
      ],
      "fieldConfig": { "defaults": { "unit": "reqps" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 6, "x": 12, "y": 47 }
    },
    {
      "type": "timeseries",
      "title": "Agg: window duration (p95)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(agg_window_duration_seconds_bucket[5m])))",
          "legendFormat": "p95"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s" }, "overrides": [] },
      "gridPos": { "h": 7, "w": 6, "x": 18, "y": 47 }
    }
  ],
  "templating": { "list": [] },
  "time": { "from": "now-6h", "to": "now" }
}